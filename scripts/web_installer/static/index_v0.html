<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXFIN OPS Setup</title>
    <link rel="stylesheet" href="style.css?v=1.0.4">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="background-globes">
        <div class="globe g1"></div>
        <div class="globe g2"></div>
    </div>

    <div class="installer-container" id="app">

        <!-- Header -->
        <header>
            <div class="logo">EXFIN <span>API KURULUM S─░STEM─░</span></div>
            <div class="step-indicator">
                <div class="step active" id="s1">1</div>
                <div class="line"></div>
                <div class="step" id="s2">2</div>
                <div class="line"></div>
                <div class="step" id="s3">3</div>
                <div class="line"></div>
                <div class="step" id="s4">4</div>
                <div class="line"></div>
                <div class="step" id="s5">5</div>
            </div>
        </header>

        <!-- Step 1: App Selection -->
        <div class="card active" id="card-1">
            <h1>Uygulama Se├ğimi</h1>
            <p class="intro-text">Kurmak istedi─şiniz EXFIN ├ğ├Âz├╝m├╝n├╝ se├ğin. Her ├ğ├Âz├╝m kendi veritaban─▒ yap─▒s─▒ ve API
                yap─▒land─▒rmas─▒ ile gelir.</p>

            <div class="app-selector">
                <div class="app-card" onclick="selectApp('OPS', this)">
                    <div class="app-icon">ÔÜÖ´©Å</div>
                    <div class="app-info">
                        <h3>EXFIN OPS</h3>
                        <p>Genel Operasyon Y├Ânetimi</p>
                    </div>
                </div>
                <div class="app-card" onclick="selectApp('RETAIL', this)">
                    <div class="app-icon">­şøÆ</div>
                    <div class="app-info">
                        <h3>EXFIN RETAIL</h3>
                        <p>Perakende & Ma─şazac─▒l─▒k</p>
                    </div>
                </div>
                <div class="app-card" onclick="selectApp('HRM', this)">
                    <div class="app-icon">­şæÑ</div>
                    <div class="app-info">
                        <h3>EXFIN HRM - PDKS</h3>
                        <p>─░nsan Kaynaklar─▒ & Personel</p>
                    </div>
                </div>
                <div class="app-card" onclick="selectApp('REST', this)">
                    <div class="app-icon">­şîÉ</div>
                    <div class="app-info">
                        <h3>EXFIN REST</h3>
                        <p>Modern Restful API Servisi</p>
                    </div>
                </div>
                <div class="app-card" onclick="selectApp('BEATPY', this)">
                    <div class="app-icon">­şÉı</div>
                    <div class="app-info">
                        <h3>EXFIN BEATPY</h3>
                        <p>Python Destekli Analiz & BI</p>
                    </div>
                </div>
                <div class="app-card" onclick="selectApp('EXCHANGE', this)">
                    <div class="app-icon">­şÆ▒</div>
                    <div class="app-info">
                        <h3>EXFIN EXCHANGE</h3>
                        <p>D├Âviz B├╝rolar─▒ (TR & IQ Market)</p>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <button class="btn btn-primary" id="btn-next-1" disabled onclick="goToStep(2)">Uygulamay─▒ Se├ğ ve Devam
                    Et</button>
            </div>
        </div>

        <!-- Step 2: Welcome & Checks -->
        <div class="card" id="card-2">
            <h1>Sistem Kontrol├╝</h1>
            <p class="intro-text">EXFIN Kurumsal Operasyon Y├Ânetim Sistemi kurulumuna ho┼ş geldiniz. Bu sihirbaz,
                i┼şletmenizin t├╝m dijital s├╝re├ğlerini tek bir platformda toplaman─▒za yard─▒mc─▒ olur.</p>

            <div class="module-cards">
                <div class="mod-card">
                    <div class="mod-icon">­şÉİ</div>
                    <h4>Logo Entegrasyonu</h4>
                    <p>Tiger/Go3 ERP verilerinizi anl─▒k olarak EXFIN'e aktar─▒r, ├ğift y├Ânl├╝ konu┼şur.</p>
                </div>
                <div class="mod-card">
                    <div class="mod-icon">­şøÆ</div>
                    <h4>Retail & Ma─şazac─▒l─▒k</h4>
                    <p>Ma─şaza sat─▒┼şlar─▒n─▒, ambar durumlar─▒n─▒ ve perakende operasyonlar─▒n─▒z─▒ y├Ânetir.</p>
                </div>
                <div class="mod-card">
                    <div class="mod-icon">ÔÅ▒´©Å</div>
                    <h4>PDKS Y├Ânetimi</h4>
                    <p>Personel giri┼ş-├ğ─▒k─▒┼ş takibi ve vardiya y├Ânetimini merkezi olarak sa─şlar.</p>
                </div>
                <div class="mod-card">
                    <div class="mod-icon">­şôè</div>
                    <h4>Analytics & BI</h4>
                    <p>T├╝m verilerinizi i┼şler, profesyonel raporlar ve dashboardlar sunar.</p>
                </div>
            </div>

            <div class="chk-list">
                <div class="chk-item" id="chk-admin">
                    <span class="icon">ÔÜ¬</span> Y├Ânetici Yetkisi (Admin)
                    <button class="btn-refresh" onclick="runPrerequisiteChecks()" title="Yeniden Kontrol Et"
                        style="margin-left: 10px; background: transparent; border: none; cursor: pointer; color: var(--primary); font-size: 14px;">­şöä</button>
                </div>
                <div class="chk-item" id="chk-python">
                    <span class="icon">ÔÜ¬</span> Python S├╝r├╝m├╝ (3.10+)
                </div>
                <div class="chk-item" id="chk-ram">
                    <span class="icon">ÔÜ¬</span> Sistem Kaynaklar─▒
                </div>
            </div>

            <div class="card-footer">
                <button class="btn btn-secondary" onclick="goBack(1)">Geri D├Ân</button>
                <button class="btn btn-primary" id="btn-start" disabled onclick="goToStep(3)">Sistem Kontrol├╝n├╝ Tamamla
                    ve Ba┼şla</button>
            </div>
        </div>

        <!-- Step 3: Database Configuration -->
        <div class="card" id="card-3">
            <h1>Veritaban─▒ Yap─▒land─▒rmas─▒</h1>
            <p class="intro-text">Uygulama verilerinin saklanaca─ş─▒ PostgreSQL ve ERP entegrasyonu i├ğin MSSQL bilgilerini
                girin.</p>

            <div class="db-tabs">
                <div class="db-tab active" id="tab-local" onclick="switchDBTab('local')">Yerel Kurulum</div>
                <div class="db-tab" id="tab-migration" onclick="switchDBTab('migration')">Sunucudan Ta┼ş─▒ma</div>
            </div>

            <div id="local-db-area">
                <div class="db-grid">
                    <!-- PostgreSQL -->
                    <div class="db-panel">
                        <div class="db-header">
                            <img src="https://wiki.postgresql.org/images/a/a4/PostgreSQL_logo.3colors.svg" alt="PG">
                            <h3>PostgreSQL (Ana Veritaban─▒)</h3>
                        </div>
                        <div class="input-group">
                            <label>Host</label>
                            <input type="text" id="pg-host" value="localhost">
                        </div>
                        <div class="input-group">
                            <label>Port</label>
                            <input type="text" id="pg-port" value="5432">
                        </div>
                        <div class="input-group">
                            <label>Kullan─▒c─▒</label>
                            <input type="text" id="pg-user" value="postgres">
                        </div>
                        <div class="input-group">
                            <label>┼Şifre</label>
                            <div class="password-wrapper">
                                <input type="password" id="pg-pass">
                                <span class="toggle-password" onclick="togglePassword('pg-pass')">­şæü´©Å</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>DB Ad─▒</label>
                            <input type="text" id="pg-db" value="EXFINOPS">
                        </div>
                        <div class="input-group checkbox-group">
                            <input type="checkbox" id="load-demo">
                            <label for="load-demo">├ûrnek Demo Verileri Y├╝kle</label>
                        </div>

                        <div class="backup-section">
                            <div style="font-size: 12px; font-weight: bold; margin-bottom: 10px; color: var(--accent);">
                                ­şöä Otomatik Yedekleme</div>
                            <div class="input-group">
                                <label>Yedekleme Dizini</label>
                                <input type="text" id="backup-dir" value="C:\EXFIN_Backups">
                            </div>
                            <div class="backup-grid">
                                <div class="input-group">
                                    <label>S─▒kl─▒k</label>
                                    <select id="backup-interval" class="custom-select" onchange="toggleBackupOptions()">
                                        <option value="off">Kapal─▒</option>
                                        <option value="hourly">Saatlik</option>
                                        <option value="daily" selected>G├╝nl├╝k</option>
                                        <option value="weekly">Haftal─▒k</option>
                                    </select>
                                </div>
                                <div class="input-group" id="backup-time-group">
                                    <label>Saat</label>
                                    <input type="text" id="backup-time" value="23:00">
                                </div>
                                <div class="input-group hidden" id="backup-hour-group">
                                    <label>Saat Aral─▒─ş─▒</label>
                                    <input type="number" id="backup-hours" value="1" min="1" max="24">
                                </div>
                            </div>
                            <div id="backup-days-group" class="hidden">
                                <label style="font-size: 12px; color: var(--text-muted);">G├╝nler</label>
                                <div class="day-selector">
                                    <div class="day-item"><input type="checkbox" value="mon"> Pzt</div>
                                    <div class="day-item"><input type="checkbox" value="tue"> Sal</div>
                                    <div class="day-item"><input type="checkbox" value="wed"> ├çar</div>
                                    <div class="day-item"><input type="checkbox" value="thu"> Per</div>
                                    <div class="day-item"><input type="checkbox" value="fri"> Cum</div>
                                    <div class="day-item"><input type="checkbox" value="sat"> Cmt</div>
                                    <div class="day-item"><input type="checkbox" value="sun"> Paz</div>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-secondary" onclick="testDB('postgres')" style="margin-top: 15px;">Test
                            Et</button>
                    </div>

                    <!-- MSSQL / Logo -->
                    <div class="db-panel">
                        <div class="db-header">
                            <img src="https://www.svgrepo.com/show/303229/microsoft-sql-server-logo.svg" alt="SQL">
                            <h3>Logo ERP (Opsiyonel)</h3>
                        </div>
                        <div class="input-group">
                            <label>Host</label>
                            <input type="text" id="ms-host" value=".">
                        </div>
                        <div class="input-group">
                            <label>Port</label>
                            <input type="text" id="ms-port" value="1433">
                        </div>
                        <div class="input-group">
                            <label>Kullan─▒c─▒</label>
                            <input type="text" id="ms-user" value="sa">
                        </div>
                        <div class="input-group">
                            <label>┼Şifre</label>
                            <div class="password-wrapper">
                                <input type="password" id="ms-pass">
                                <span class="toggle-password" onclick="togglePassword('ms-pass')">­şæü´©Å</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>DB Ad─▒</label>
                            <input type="text" id="ms-db" value="TIGER3">
                        </div>
                        <button class="btn btn-secondary" onclick="testDB('mssql')">Ba─şlant─▒y─▒ Test Et</button>

                        <div id="logo-firm-area" class="hidden">
                            <label
                                style="display:block; margin: 15px 0 5px 0; font-size: 12px; color: var(--text-muted);">Aktar─▒lacak
                                Logo Firmas─▒n─▒ Se├ğin</label>
                            <select id="logo-firm-select" class="custom-select">
                                <option value="">Firma Se├ğin...</option>
                            </select>
                            <button class="btn-preview" onclick="openPreview('companies')"
                                style="margin-top: 10px; width: 100%;">Firmalar─▒ ├ûnizle</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="migration-db-area" class="hidden">
                <div class="db-panel" style="max-width: 100%;">
                    <div class="db-header">
                        <img src="https://avatars.githubusercontent.com/u/54469796?s=280&v=4" alt="Cloud">
                        <h3>Evrensel Veri Ta┼ş─▒ma & Bulut Entegrasyonu</h3>
                    </div>

                    <div class="migration-controls"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>Kaynak Veritaban─▒ Tipi</label>
                            <select id="remote-db-type" class="custom-select" onchange="toggleMigrationType()">
                                <option value="postgres">PostgreSQL / Supabase (Direkt)</option>
                                <option value="supabase_api">Supabase (API/Token ile Listele)</option>
                                <option value="mssql">MS SQL Server (Uzak)</option>
                                <option value="mysql">MySQL (Uzak)</option>
                            </select>
                        </div>

                        <div id="supabase-api-login" class="hidden">
                            <div class="input-group">
                                <label style="display: flex; justify-content: space-between;">
                                    Supabase Token
                                    <a href="https://supabase.com/dashboard/account/tokens" target="_blank"
                                        style="font-size: 10px; color: var(--primary); text-decoration: none;">Token Al
                                        Ôåù</a>
                                </label>
                                <div style="display: flex; gap: 10px;">
                                    <div class="password-wrapper" style="flex: 1;">
                                        <input type="password" id="supabase-token" placeholder="sbp_xxxxxxxxxxxx"
                                            style="width: 100%;">
                                        <span class="toggle-password"
                                            onclick="togglePassword('supabase-token')">­şæü´©Å</span>
                                    </div>
                                    <button class="btn btn-secondary" onclick="fillMigrationDefaults()"
                                        style="padding: 8px 15px; background: rgba(var(--primary-rgb), 0.1); border-color: var(--primary);">Varsay─▒lan</button>
                                    <button class="btn btn-secondary" onclick="fetchSupabaseProjects()"
                                        style="padding: 8px 15px;">Listele</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        style="background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-size: 12px; font-weight: bold; color: var(--text-muted);">HEDEF VER─░TABANI
                                (YEREL)</span>
                            <select id="migration-target" class="custom-select"
                                style="width: auto; padding: 5px 10px; font-size: 11px;">
                                <option value="postgres">Yerel PostgreSQL (Ana)</option>
                                <option value="mssql">Yerel Logo DB (MSSQL)</option>
                            </select>
                        </div>
                        <div id="local-db-info"
                            style="font-family: monospace; font-size: 11px; color: var(--success); opacity: 0.8;">
                            PostgreSQL: Ba─şlant─▒ haz─▒r...
                        </div>
                    </div>

                    <div class="db-grid" style="grid-template-columns: 1.5fr 1fr; gap: 20px;">
                        <div>
                            <div id="remote-conn-field">
                                <div class="input-group">
                                    <label id="remote-conn-label">Uzak Sunucu Ba─şlant─▒ Dizesi</label>
                                    <input type="text" id="remote-conn-str"
                                        placeholder="postgresql://user:pass@host:port/db">
                                </div>
                            </div>

                            <div id="supabase-project-list" class="hidden">
                                <div class="input-group">
                                    <label>Supabase Projesi Se├ğin</label>
                                    <select id="supabase-project-select" class="custom-select"
                                        onchange="selectSupabaseProject()">
                                        <option value="">Proje Se├ğin...</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-secondary" onclick="analyzeRemoteDB()">┼Şemay─▒ Analiz Et</button>
                        </div>
                        <div id="migration-log" class="log-output" style="height: 180px; font-size: 11px;">
                            Kaynak sunucu analizi bekleniyor...
                        </div>
                    </div>
                    <div id="remote-tables-view" class="data-selection-list hidden">
                        <!-- Remote tables will load here -->
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <button class="btn btn-secondary" onclick="goBack(2)">Geri D├Ân</button>
                <div id="db-status"></div>
                <button class="btn btn-primary" id="btn-next-db" disabled onclick="handleDBFinish()">Veritaban─▒n─▒ Kur ve
                    Devam Et</button>
            </div>
        </div>

        <!-- Step 4: Logo Data Selection -->
        <div class="card" id="card-4">
            <div class="step-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <img src="https://www.svgrepo.com/show/303229/microsoft-sql-server-logo.svg" alt="Logo"
                    style="width: 48px; filter: drop-shadow(0 0 10px var(--primary));">
                <div>
                    <h1 style="margin: 0;">Logo Veri Aktar─▒m─▒</h1>
                    <p class="intro-text" style="margin: 0;">Ba─şlan─▒lan firmadan aktar─▒lacak detayl─▒ verileri se├ğin.</p>
                </div>
            </div>

            <div id="logo-selection-container"
                style="display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px; margin-top: 10px;">
                <div class="selection-panel">
                    <div class="selection-header">
                        <span>­şæñ Sat─▒┼ş Elemanlar─▒ (Sat─▒┼ş├ğ─▒ Giri┼şi)</span>
                        <button class="btn-preview" onclick="openPreview('salesmen')">├ûnizle</button>
                    </div>
                    <div class="data-selection-list" style="padding:0;">
                        <table class="selection-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="sel-all-salesmen"
                                            onchange="selectAll('salesmen', this.checked)" title="T├╝m├╝n├╝ Se├ğ"></th>
                                    <th style="width: 80px;">Kod</th>
                                    <th>─░sim / A├ğ─▒klama</th>
                                    <th style="width: 120px;">Kullan─▒c─▒ Ad─▒</th>
                                    <th style="width: 120px;">┼Şifre</th>
                                </tr>
                            </thead>
                            <tbody id="list-salesmen">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding:20px;">Veriler bekleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="selection-panel">
                    <div class="selection-header">
                        <span>­şÅá Ambarlar / Depolar</span>
                        <button class="btn-preview" onclick="openPreview('warehouses')">├ûnizle</button>
                    </div>
                    <div class="data-selection-list" style="padding:0;">
                        <table class="selection-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" id="sel-all-warehouses"
                                            onchange="selectAll('warehouses', this.checked)" title="T├╝m├╝n├╝ Se├ğ"></th>
                                    <th style="width: 80px;">No</th>
                                    <th>Ambar Ad─▒</th>
                                </tr>
                            </thead>
                            <tbody id="list-warehouses">
                                <tr>
                                    <td colspan="3" style="text-align:center; padding:20px;">Veriler bekleniyor...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card-footer" style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="goBack(3)">Geri D├Ân</button>
                <button class="btn btn-primary" onclick="goToStep(5)">Se├ğili Verileri Senkronize Et ve Kuruluma
                    Ba┼şla</button>
            </div>
        </div>

        <!-- Step 5: Installation Progress -->
        <div class="card" id="card-5">
            <h2>Kurulum Tamamlan─▒yor</h2>

            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>

            <div class="log-output" id="install-logs">
                > Kurulum ba┼şlat─▒l─▒yor...
            </div>

            <div class="success-screen hidden" id="success-screen">
                <div class="checkmark">
                    <img src="modern_database_icon_v2.png" alt="Check"
                        style="width: 80px; filter: drop-shadow(0 0 10px var(--primary));">
                </div>
                <h3 style="margin-top: 20px;">Kurulum Ba┼şar─▒l─▒!</h3>
                <p>EXFIN <span id="success-app-name"></span> Servisi arka planda ├ğal─▒┼ş─▒yor.</p>
                <div class="dashboard-link">
                    <button class="btn btn-primary" onclick="launchTray()">Tepsiyi (Tray) Ba┼şlat</button>
                    <button class="btn btn-secondary" id="btn-ssl" onclick="generateSSL()">SSL Sertifikas─▒
                        Olu┼ştur</button>
                    <a href="http://localhost:8000/docs" target="_blank" class="btn btn-secondary">Swagger API A├ğ</a>
                </div>
            </div>
        </div>

        <!-- Modal for Previews -->
        <div id="preview-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-title">Veri ├ûnizleme</h2>
                    <span class="close-btn" onclick="closeModal()">├ù</span>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Preview content loaded here -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Kapat</button>
                </div>
            </div>
        </div>

    </div>

    <script src="app.js?v=1.0.4"></script>
</body>

</html>
